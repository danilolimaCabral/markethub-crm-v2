name: Deploy to Hetzner Production

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deploy'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # Job 1: Testes (pode ser pulado em emerg√™ncia)
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.skip_tests != 'true'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: markethub_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run database migrations
        run: pnpm run migrate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/markethub_test

      - name: Run tests
        run: pnpm test
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/markethub_test
          JWT_SECRET: test-jwt-secret-min-32-characters-long
          JWT_REFRESH_SECRET: test-refresh-secret-min-32-characters

      - name: Build application
        run: pnpm build

  # Job 2: Deploy no Hetzner
  deploy:
    name: Deploy to Hetzner Server
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    environment:
      name: production
      url: https://www.markthubcrm.com.br
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts
          echo "‚úÖ SSH configurado"

      - name: Deploy to Hetzner
        run: |
          ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'ENDSSH'
            set -e  # Parar em caso de erro
            
            # Cores para output
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            RED='\033[0;31m'
            NC='\033[0m' # No Color
            
            echo -e "${GREEN}üöÄ Iniciando deploy...${NC}"
            
            # Navegar para pasta da aplica√ß√£o
            echo -e "${YELLOW}üìÇ Navegando para pasta da aplica√ß√£o...${NC}"
            cd /var/www/markethub-crm || cd /opt/markethub-crm || cd ~/markethub-crm || {
              echo -e "${RED}‚ùå Pasta da aplica√ß√£o n√£o encontrada!${NC}"
              exit 1
            }
            
            # Backup antes de deploy
            echo -e "${YELLOW}üì¶ Criando backup...${NC}"
            BACKUP_DIR="backups"
            mkdir -p $BACKUP_DIR
            BACKUP_FILE="$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz"
            tar -czf $BACKUP_FILE dist/ .env 2>/dev/null || true
            echo -e "${GREEN}‚úÖ Backup criado: $BACKUP_FILE${NC}"
            
            # Limpar backups antigos (manter √∫ltimos 5)
            ls -t $BACKUP_DIR/backup-*.tar.gz | tail -n +6 | xargs rm -f 2>/dev/null || true
            
            # Atualizar c√≥digo
            echo -e "${YELLOW}‚¨áÔ∏è  Atualizando c√≥digo do GitHub...${NC}"
            git fetch origin
            CURRENT_COMMIT=$(git rev-parse HEAD)
            git reset --hard origin/main
            NEW_COMMIT=$(git rev-parse HEAD)
            
            if [ "$CURRENT_COMMIT" = "$NEW_COMMIT" ]; then
              echo -e "${YELLOW}‚ÑπÔ∏è  Nenhuma mudan√ßa no c√≥digo${NC}"
            else
              echo -e "${GREEN}‚úÖ C√≥digo atualizado: $CURRENT_COMMIT -> $NEW_COMMIT${NC}"
            fi
            
            # Instalar/atualizar depend√™ncias
            echo -e "${YELLOW}üìö Instalando depend√™ncias...${NC}"
            pnpm install --frozen-lockfile --prod || pnpm install --prod
            echo -e "${GREEN}‚úÖ Depend√™ncias instaladas${NC}"
            
            # Build da aplica√ß√£o
            echo -e "${YELLOW}üî® Building aplica√ß√£o...${NC}"
            NODE_ENV=production pnpm build
            echo -e "${GREEN}‚úÖ Build conclu√≠do${NC}"
            
            # Rodar migrations
            echo -e "${YELLOW}üíæ Executando migrations do banco de dados...${NC}"
            pnpm run migrate || {
              echo -e "${RED}‚ö†Ô∏è  Migrations falharam! Continuando...${NC}"
            }
            echo -e "${GREEN}‚úÖ Migrations executadas${NC}"
            
            # Reiniciar aplica√ß√£o
            echo -e "${YELLOW}üîÑ Reiniciando aplica√ß√£o...${NC}"
            
            # Tentar PM2 primeiro
            if command -v pm2 &> /dev/null; then
              pm2 restart markethub-crm --update-env || pm2 start dist/index.js --name markethub-crm
              echo -e "${GREEN}‚úÖ Aplica√ß√£o reiniciada via PM2${NC}"
            # Se n√£o, tentar systemd
            elif systemctl is-active --quiet markethub-crm; then
              systemctl restart markethub-crm
              echo -e "${GREEN}‚úÖ Aplica√ß√£o reiniciada via systemd${NC}"
            else
              echo -e "${RED}‚ö†Ô∏è  PM2/systemd n√£o encontrado. Reinicie manualmente!${NC}"
            fi
            
            # Aguardar aplica√ß√£o iniciar
            echo -e "${YELLOW}‚è≥ Aguardando aplica√ß√£o iniciar...${NC}"
            sleep 5
            
            # Verificar status
            echo -e "${YELLOW}üîç Verificando status...${NC}"
            if command -v pm2 &> /dev/null; then
              pm2 status markethub-crm
              pm2 logs markethub-crm --lines 10 --nostream
            elif systemctl is-active --quiet markethub-crm; then
              systemctl status markethub-crm --no-pager
            fi
            
            echo -e "${GREEN}üéâ Deploy conclu√≠do com sucesso!${NC}"
            echo -e "${GREEN}Commit: $NEW_COMMIT${NC}"
            echo -e "${GREEN}Data: $(date)${NC}"
          ENDSSH

      - name: Wait for application to start
        run: sleep 10

      - name: Health check
        run: |
          echo "üè• Verificando sa√∫de da aplica√ß√£o..."
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s https://www.markthubcrm.com.br/api/health; then
              echo "‚úÖ Health check passou!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚ö†Ô∏è  Tentativa $RETRY_COUNT/$MAX_RETRIES falhou. Aguardando 5s..."
            sleep 5
          done
          
          echo "‚ùå Health check falhou ap√≥s $MAX_RETRIES tentativas!"
          exit 1

      - name: Notify success
        if: success()
        run: |
          echo "üéâ Deploy realizado com sucesso!"
          echo "üåê URL: https://www.markthubcrm.com.br"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üë§ Por: ${{ github.actor }}"
          echo "üïê Em: $(date)"

  # Job 3: Rollback autom√°tico em caso de falha
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts

      - name: Execute rollback
        run: |
          ssh ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'ENDSSH'
            RED='\033[0;31m'
            YELLOW='\033[1;33m'
            GREEN='\033[0;32m'
            NC='\033[0m'
            
            echo -e "${RED}üö® DEPLOY FALHOU! Executando rollback...${NC}"
            
            cd /var/www/markethub-crm || cd /opt/markethub-crm || cd ~/markethub-crm
            
            # Encontrar √∫ltimo backup
            LAST_BACKUP=$(ls -t backups/backup-*.tar.gz 2>/dev/null | head -1)
            
            if [ -n "$LAST_BACKUP" ]; then
              echo -e "${YELLOW}üì¶ Restaurando backup: $LAST_BACKUP${NC}"
              tar -xzf $LAST_BACKUP
              
              # Reiniciar aplica√ß√£o
              if command -v pm2 &> /dev/null; then
                pm2 restart markethub-crm
              elif systemctl is-active --quiet markethub-crm; then
                systemctl restart markethub-crm
              fi
              
              echo -e "${GREEN}‚úÖ Rollback conclu√≠do!${NC}"
            else
              echo -e "${RED}‚ùå Nenhum backup encontrado!${NC}"
              echo -e "${YELLOW}‚ÑπÔ∏è  Aplica√ß√£o permanece no estado atual${NC}"
            fi
          ENDSSH

      - name: Notify rollback
        run: |
          echo "üö® DEPLOY FALHOU E FOI REVERTIDO"
          echo "‚ö†Ô∏è  Sistema voltou para vers√£o anterior"
          echo "üîç Verifique os logs para detalhes"
          echo "üë§ Respons√°vel: ${{ github.actor }}"
          echo "üìù Commit que falhou: ${{ github.sha }}"
